<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login | GT Mall</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Your main CSS (already made by you) -->
  <link rel="stylesheet" href="style.css">

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

  <!-- ✅ Correct Firebase config -->
  <script>
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyB08MQegakweUn5Qtc-w95NQztn0z1M3xQ",
      authDomain: "gtmall-7b220.firebaseapp.com",
      projectId: "gtmall-7b220",
      storageBucket: "gtmall-7b220.appspot.com",
      messagingSenderId: "303908707758",
      appId: "1:303908707758:web:8bb9127fcc92f308c93c3f",
      measurementId: "G-HQTXK2NTQ3"
    };

    firebase.initializeApp(firebaseConfig);
  </script>
</head>
<body>

  <!-- (Invisible, just to satisfy Firebase if needed) -->
  <div id="recaptcha-container"></div>

  <div class="main-container" id="mainContainer">
    
    <div class="form-container">
      
      <!-- ============ SIGN UP (LEFT SIDE) ============ -->
      <form id="signupForm" class="sign-up-form form-box">
        <div class="logo-placeholder">GT Mall</div>
        <h2>Create Account</h2>

        <!-- Name -->
        <input type="text" id="signupName" placeholder="Name" required>

        <!-- Mobile + SEND OTP, same row -->
        <div style="display:flex; gap:8px; margin:8px 0;">
          <input type="text" id="signupMobileInput" placeholder="Mobile no." required style="flex:1;">
          <button type="button"
                  id="signupSendOtpButton"
                  class="ghost-btn"
                  style="white-space:nowrap; padding: 10px 18px; background-color:#a6ce39; color:#fff; border:none; border-radius:999px; font-weight:600;">
            SEND OTP
          </button>
        </div>

        <!-- ENTER OTP instead of password -->
        <input type="text" id="signupOtpInput" placeholder="ENTER OTP" required disabled>

        <button type="submit" class="sign-up-btn">SIGN UP</button>
      </form>

      <!-- ============ SIGN IN (RIGHT SIDE WHITE FORM) ============ -->
      <form id="loginForm" class="sign-in-form form-box">
        <div class="logo-placeholder">GT Mall</div>
        <h2>Sign In</h2>

        <!-- OTP Login only -->
        <div id="otpLoginSection" style="display:flex; flex-direction:column;">
          <input type="text" id="otpMobileInput" placeholder="Enter Mobile Number (e.g., 9876543210)" required> 
          <button type="button" id="sendOtpButton" class="ghost-btn"
                  style="width:100%; margin-top:10px; margin-bottom:15px; background-color:#a6ce39; color:#fff; border:none;">
            SEND OTP
          </button>
          <input type="text" id="otpInput" placeholder="ENTER OTP" disabled required>
          <button type="button" id="verifyOtpButton" class="sign-in-btn" style="margin-top:15px;" disabled>
            VERIFY & LOGIN
          </button>
        </div>

        <!-- (Old password login removed to avoid confusion) -->
      </form>
    </div>

    <!-- ============ GREEN SIDE PANEL (Already styled in your CSS) ============ -->
    <div class="split-panel welcome-panel">
      <div class="content" id="overlay-content">
        <h1 id="overlay-title">Welcome Back!</h1>
        <p id="overlay-text">To keep connected with us, please login with your personal info</p>
        <button class="ghost-btn" id="slideToggleBtn">SIGN IN</button>
      </div>
    </div>
  </div>

  <script>
    // If already logged in, send to home
    if (localStorage.getItem("userName")) {
      window.location.href = "index.html";
    }

    let signupConfirmationResult = null;
    let loginConfirmationResult = null;
    let signupRecaptchaVerifier = null;
    let loginRecaptchaVerifier = null;

    document.addEventListener("DOMContentLoaded", () => {
      const mainContainer = document.getElementById('mainContainer');
      const slideToggleBtn = document.getElementById('slideToggleBtn');

      // SIGNUP elements
      const signupForm = document.getElementById('signupForm');
      const signupNameInput = document.getElementById('signupName');
      const signupMobileInput = document.getElementById('signupMobileInput');
      const signupOtpInput = document.getElementById('signupOtpInput');
      const signupSendOtpButton = document.getElementById('signupSendOtpButton');

      // LOGIN elements
      const loginForm = document.getElementById('loginForm');
      const otpMobileInput = document.getElementById('otpMobileInput');
      const otpInput = document.getElementById('otpInput');
      const sendOtpButton = document.getElementById('sendOtpButton');
      const verifyOtpButton = document.getElementById('verifyOtpButton');

      // Disable default submit (we handle manually)
      loginForm.addEventListener("submit", (e) => e.preventDefault());

      // ========== Sliding animation between SignUp & SignIn ==========
      slideToggleBtn.addEventListener('click', () => {
        mainContainer.classList.toggle('sign-in-active');
        
        const overlayTitle = document.getElementById('overlay-title');
        const overlayText = document.getElementById('overlay-text');
        
        if (mainContainer.classList.contains('sign-in-active')) {
          overlayTitle.textContent = 'Hello, Friend!';
          overlayText.textContent = 'Enter your personal details and start your journey with us';
          slideToggleBtn.textContent = 'SIGN UP';
        } else {
          overlayTitle.textContent = 'Welcome Back!';
          overlayText.textContent = 'To keep connected with us, please login with your personal info';
          slideToggleBtn.textContent = 'SIGN IN';
        }
      });

      // ================================================================
      //                SIGNUP → SEND OTP
      // ================================================================
      signupSendOtpButton.addEventListener('click', () => {
        const mobile = signupMobileInput.value.trim();
        if (mobile.length !== 10 || isNaN(mobile)) {
          alert("Please enter a valid 10-digit mobile number.");
          return;
        }
        const phoneNumber = "+91" + mobile;

        // Create recaptcha for signup (invisible, attached to button)
        if (!signupRecaptchaVerifier) {
          signupRecaptchaVerifier = new firebase.auth.RecaptchaVerifier(
            'signupSendOtpButton',
            { size: 'invisible' }
          );
        }

        signupMobileInput.disabled = true;
        signupSendOtpButton.disabled = true;
        signupSendOtpButton.textContent = "Sending...";

        signupRecaptchaVerifier.render().then(() => {
          return firebase.auth().signInWithPhoneNumber(phoneNumber, signupRecaptchaVerifier);
        })
        .then((result) => {
          signupConfirmationResult = result;

          signupOtpInput.disabled = false;
          signupOtpInput.focus();

          alert(`OTP sent to ${mobile}. Please check your phone.`);

          let timeLeft = 30;
          const timer = setInterval(() => {
            timeLeft--;
            signupSendOtpButton.textContent = `RESEND OTP (${timeLeft}s)`;
            if (timeLeft <= 0) {
              clearInterval(timer);
              signupSendOtpButton.textContent = "SEND OTP";
              signupSendOtpButton.disabled = false;
              signupMobileInput.disabled = false;
            }
          }, 1000);
        })
        .catch((error) => {
          console.error("SIGNUP OTP error:", error);
          alert("Failed to send OTP. Error: " + error.message);
          signupSendOtpButton.textContent = "SEND OTP";
          signupSendOtpButton.disabled = false;
          signupMobileInput.disabled = false;
        });
      });

      // ================================================================
      //                SIGNUP → VERIFY OTP & CREATE ACCOUNT
      // ================================================================
      signupForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const name = signupNameInput.value.trim();
        const mobile = signupMobileInput.value.trim();
        const otp = signupOtpInput.value.trim();

        if (!name || !mobile || !otp) {
          alert("Please fill in Name, Mobile and OTP.");
          return;
        }

        if (!signupConfirmationResult) {
          alert("Please send OTP first.");
          return;
        }

        signupConfirmationResult.confirm(otp)
          .then((result) => {
            // Verified via Firebase
            localStorage.setItem("userRegisteredName", name);
            localStorage.setItem("userRegisteredMobile", mobile);
            localStorage.setItem("userName", name);  // show name in navbar
            sessionStorage.setItem("welcomeShown", "false");

            alert(`Account created successfully! Welcome, ${name}.`);
            window.location.href = "index.html";
          })
          .catch((error) => {
            console.error("SIGNUP OTP verify error:", error);
            alert("Invalid OTP for signup. Please try again.");
          });
      });

      // ================================================================
      //                LOGIN → SEND OTP
      // ================================================================
      sendOtpButton.addEventListener('click', () => {
        const mobile = otpMobileInput.value.trim();
        if (mobile.length !== 10 || isNaN(mobile)) {
          alert("Please enter a valid 10-digit mobile number.");
          return;
        }
        const phoneNumber = "+91" + mobile;

        if (!loginRecaptchaVerifier) {
          loginRecaptchaVerifier = new firebase.auth.RecaptchaVerifier(
            'sendOtpButton',
            { size: 'invisible' }
          );
        }

        otpMobileInput.disabled = true;
        sendOtpButton.disabled = true;
        sendOtpButton.textContent = "Sending...";

        loginRecaptchaVerifier.render().then(() => {
          return firebase.auth().signInWithPhoneNumber(phoneNumber, loginRecaptchaVerifier);
        })
        .then((result) => {
          loginConfirmationResult = result;

          otpInput.disabled = false;
          verifyOtpButton.disabled = false;
          otpInput.focus();

          alert(`OTP sent to ${mobile}. Please check your phone.`);

          let timeLeft = 30;
          const timer = setInterval(() => {
            timeLeft--;
            sendOtpButton.textContent = `RESEND OTP (${timeLeft}s)`;
            if (timeLeft <= 0) {
              clearInterval(timer);
              sendOtpButton.textContent = "SEND OTP";
              sendOtpButton.disabled = false;
              otpMobileInput.disabled = false;
            }
          }, 1000);
        })
        .catch((error) => {
          console.error("LOGIN OTP error:", error);
          alert("Failed to send OTP. Error: " + error.message);
          sendOtpButton.textContent = "SEND OTP";
          sendOtpButton.disabled = false;
          otpMobileInput.disabled = false;
        });
      });

      // ================================================================
      //                LOGIN → VERIFY OTP
      // ================================================================
      verifyOtpButton.addEventListener('click', () => {
        const enteredOTP = otpInput.value.trim();

        if (enteredOTP.length !== 6 || isNaN(enteredOTP)) {
          alert("Please enter a valid 6-digit OTP.");
          return;
        }

        if (!loginConfirmationResult) {
          alert("Please send the OTP first.");
          return;
        }

        verifyOtpButton.disabled = true;
        verifyOtpButton.textContent = "Verifying...";

        loginConfirmationResult.confirm(enteredOTP)
          .then((result) => {
            const mobile = otpMobileInput.value.trim();
            localStorage.setItem("userName", mobile);
            sessionStorage.setItem("welcomeShown", "false");
            alert(`Verification Successful! Welcome, ${mobile}.`);
            window.location.href = "index.html";
          })
          .catch((error) => {
            console.error("LOGIN OTP verify error:", error);
            alert("Invalid OTP. Please try again.");
            verifyOtpButton.disabled = false;
            verifyOtpButton.textContent = "VERIFY & LOGIN";
          });
      });

      otpInput.addEventListener('keyup', (e) => {
        if (e.key === 'Enter' && !verifyOtpButton.disabled) {
          verifyOtpButton.click();
        }
      });

    });
  </script>

</body>
</html>
