<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login | GT Mall</title>

  <!-- Bootstrap (for simple responsive layout) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Your main CSS (optional, for navbar/footer consistency) -->
  <link rel="stylesheet" href="style.css" />

  <!-- Firebase v9+ (modular) -->
  <script type="module">
    // âœ… Firebase imports (from CDN)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth,
      RecaptchaVerifier,
      signInWithPhoneNumber,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // âœ… Tumhara existing Firebase config (same as pehle)
    const firebaseConfig = {
      apiKey: "AIzaSyB88MqegaekweUn5Qtc-w9SMQ2tn02iM3xQ",
      authDomain: "gtmall-7b220.firebaseapp.com",
      projectId: "gtmall-7b220",
      storageBucket: "gtmall-7b220.firebasestorage.app",
      messagingSenderId: "303908707758",
      appId: "1:303908707758:web:8bb9127fcc92f3080c93c3f",
      measurementId: "G-HQTIKX2NTQ3"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // Agar already logged in hai, seedha home pe bhej do
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // Phone number ya kuch bhi display naam use kar sakte ho
        const phone = user.phoneNumber || "User";
        localStorage.setItem("userName", phone);
        // Welcome popup ko dubara dikhane ke liye
        sessionStorage.setItem("welcomeShown", "false");
        // Already logged in -> index pe jao
        window.location.href = "index.html";
      }
    });

    // DOM loaded
    window.addEventListener("DOMContentLoaded", () => {
      const phoneInput = document.getElementById("phone-input");
      const sendOtpBtn = document.getElementById("send-otp-btn");
      const otpSection = document.getElementById("otp-section");
      const otpInput = document.getElementById("otp-input");
      const verifyOtpBtn = document.getElementById("verify-otp-btn");
      const statusMsg = document.getElementById("status-msg");

      let confirmationResult = null;

      // ðŸ” Invisible reCAPTCHA (must be on http:// or https://, NOT file://)
      window.recaptchaVerifier = new RecaptchaVerifier(
        sendOtpBtn,
        {
          size: "invisible",
          callback: (response) => {
            console.log("reCAPTCHA solved");
          },
        },
        auth
      );

      // âžœ Step 1: Send OTP
      sendOtpBtn.addEventListener("click", async () => {
        const rawPhone = phoneInput.value.trim();

        if (rawPhone.length !== 10 || isNaN(rawPhone)) {
          statusMsg.textContent = "Please enter a valid 10-digit mobile number.";
          statusMsg.className = "text-danger mt-2";
          return;
        }

        const fullPhone = "+91" + rawPhone;

        sendOtpBtn.disabled = true;
        sendOtpBtn.textContent = "Sending OTP...";
        statusMsg.textContent = "";
        statusMsg.className = "mt-2";

        try {
          confirmationResult = await signInWithPhoneNumber(
            auth,
            fullPhone,
            window.recaptchaVerifier
          );

          statusMsg.textContent = `OTP sent to ${rawPhone}. Please check your SMS.`;
          statusMsg.className = "text-success mt-2";

          // Show OTP section
          otpSection.classList.remove("d-none");
          otpInput.focus();

          // Resend timer (30 sec)
          let timeLeft = 30;
          const originalText = "Resend OTP";
          const timer = setInterval(() => {
            timeLeft--;
            sendOtpBtn.textContent = `${originalText} (${timeLeft}s)`;
            if (timeLeft <= 0) {
              clearInterval(timer);
              sendOtpBtn.textContent = originalText;
              sendOtpBtn.disabled = false;
            }
          }, 1000);
        } catch (err) {
          console.error("Error sending OTP:", err);
          statusMsg.textContent = err.message || "Failed to send OTP.";
          statusMsg.className = "text-danger mt-2";
          sendOtpBtn.disabled = false;
          sendOtpBtn.textContent = "Send OTP";
        }
      });

      // âžœ Step 2: Verify OTP
      verifyOtpBtn.addEventListener("click", async () => {
        const code = otpInput.value.trim();

        if (!code || code.length !== 6 || isNaN(code)) {
          statusMsg.textContent = "Please enter a valid 6-digit OTP.";
          statusMsg.className = "text-danger mt-2";
          return;
        }

        if (!confirmationResult) {
          statusMsg.textContent = "Please request OTP first.";
          statusMsg.className = "text-danger mt-2";
          return;
        }

        verifyOtpBtn.disabled = true;
        verifyOtpBtn.textContent = "Verifying...";

        try {
          const result = await confirmationResult.confirm(code);
          const user = result.user;
          const phone = user.phoneNumber || phoneInput.value.trim();

          // âœ… Ab user officially logged in via Firebase
          localStorage.setItem("userName", phone);
          sessionStorage.setItem("welcomeShown", "false");

          statusMsg.textContent = "Login successful! Redirecting...";
          statusMsg.className = "text-success mt-2";

          setTimeout(() => {
            window.location.href = "index.html";
          }, 1000);
        } catch (err) {
          console.error("Error verifying OTP:", err);
          statusMsg.textContent = err.message || "Invalid OTP. Please try again.";
          statusMsg.className = "text-danger mt-2";
          verifyOtpBtn.disabled = false;
          verifyOtpBtn.textContent = "Verify & Login";
        }
      });

      // Enter key on OTP input
      otpInput.addEventListener("keyup", (e) => {
        if (e.key === "Enter") {
          verifyOtpBtn.click();
        }
      });
    });
  </script>
</head>
<body class="bg-light">

  <!-- Simple navbar / header -->
  <nav class="navbar navbar-light bg-white shadow-sm">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="index.html">
        <img src="img/logo.png" alt="GT Mall Logo" style="height:40px;width:40px;" class="me-2" />
        <span class="fw-semibold">GT Mall</span>
      </a>
      <span class="text-muted small">Secure Login</span>
    </div>
  </nav>

  <!-- Main content -->
  <div class="container d-flex justify-content-center align-items-center" style="min-height: calc(100vh - 70px);">
    <div class="card shadow-sm" style="max-width: 420px; width: 100%; border-radius: 16px;">
      <div class="card-body p-4">
        <h4 class="mb-1">Login or Signup</h4>
        <p class="text-muted mb-4" style="font-size: 0.9rem;">
          Enter your mobile number to continue with GT Mall.
        </p>

        <!-- Phone input -->
        <label class="form-label">Mobile Number</label>
        <div class="input-group mb-3">
          <span class="input-group-text">+91</span>
          <input type="tel" id="phone-input" class="form-control" placeholder="10-digit mobile number">
        </div>

        <button id="send-otp-btn" class="btn btn-success w-100 mb-3">
          Send OTP
        </button>

        <!-- OTP section (hidden initially) -->
        <div id="otp-section" class="d-none">
          <label class="form-label">Enter OTP</label>
          <input type="text" id="otp-input" class="form-control mb-3" placeholder="6-digit OTP">
          <button id="verify-otp-btn" class="btn btn-primary w-100">
            Verify & Login
          </button>
        </div>

        <div id="status-msg" class="mt-3" style="min-height: 20px; font-size:0.88rem;"></div>

        <hr class="my-4">

        <p class="text-muted mb-1" style="font-size: 0.8rem;">
          By continuing, you agree to GT Mall's Terms of Use & Privacy Policy.
        </p>
      </div>
    </div>
  </div>

</body>
</html>
