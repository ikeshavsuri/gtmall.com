<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard | GT Mall</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />

  <link rel="stylesheet" href="style.css" />
  <style>
    .badge-status {
      font-size: 0.75rem;
    }
    .table-responsive {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.05);
      padding: 16px;
    }
    .admin-header {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    @media (min-width: 768px) {
      .admin-header {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
    }
    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand" href="index.html">
        <img src="img/logo.png" alt="GT Mall Logo" /> GT Mall
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
              aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span><i class="fas fa-bars"></i></span>
      </button>

      <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
        <ul class="navbar-nav align-items-center">
          <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="shop.html">Shop</a></li>
          <li class="nav-item"><a class="nav-link" href="blog.html">Blog</a></li>
          <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
          <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
          <li class="nav-item">
            <a href="cart.html" class="nav-link"><i class="fa-solid fa-bag-shopping"></i></a>
          </li>

          <!-- Admin link -->
          <li class="nav-item ms-2">
            <a href="admin.html" class="nav-link" style="color:#a6ce39;font-weight:600;">
              <i class="fa-solid fa-user-shield me-1"></i>Admin
            </a>
          </li>

          <li class="nav-item ms-2">
            <a href="login_signup.html" class="login-btn">Login / Sign Up</a>
          </li>
          <li class="nav-item ms-2 d-none" id="logout-item">
            <button class="logout-btn">Logout</button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- ADMIN DASHBOARD CONTENT -->
  <section class="py-5">
    <div class="container">
      <div class="admin-header mb-3">
        <div>
          <h2 class="mb-1" style="color:#333;">Admin Dashboard</h2>
          <p class="text-muted mb-0" style="font-size:0.9rem;">
            View and manage all customer orders stored in MongoDB (Atlas).
          </p>
        </div>
        <div class="d-flex gap-2">
          <button id="exportBtn" class="btn btn-sm btn-outline-primary">
            <i class="fa-solid fa-file-export me-1"></i>Export CSV
          </button>
          <button id="refreshBtn" class="btn btn-sm btn-outline-success">
            <i class="fa-solid fa-rotate"></i> Refresh
          </button>
        </div>
      </div>

      <div class="filter-row mb-3">
        <div class="d-flex align-items-center gap-2">
          <span>Search:</span>
          <input id="searchInput" type="text" class="form-control form-control-sm" placeholder="User or Order ID">
        </div>
        <div class="d-flex align-items-center gap-2">
          <span>From:</span>
          <input id="dateFrom" type="date" class="form-control form-control-sm">
        </div>
        <div class="d-flex align-items-center gap-2">
          <span>To:</span>
          <input id="dateTo" type="date" class="form-control form-control-sm">
        </div>
        <button id="clearFiltersBtn" class="btn btn-sm btn-outline-secondary">
          Clear Filters
        </button>
      </div>

      <div class="mb-2">
        <span class="me-3" style="font-size:0.9rem;">
          Orders (filtered): <strong id="totalOrders">0</strong>
        </span>
        <span class="me-3" style="font-size:0.9rem;">
          Revenue (filtered): <strong>Rs. <span id="totalRevenue">0</span></strong>
        </span>
      </div>

      <div id="statusMessage" class="mb-2" style="font-size:0.9rem;"></div>

      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead>
            <tr>
              <th scope="col">Order ID</th>
              <th scope="col">User</th>
              <th scope="col">Items</th>
              <th scope="col">Total (Rs.)</th>
              <th scope="col">Status</th>
              <th scope="col">Created At</th>
              <th scope="col">Details</th>
            </tr>
          </thead>
          <tbody id="ordersTableBody">
            <!-- Filled via JS -->
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="footer-container">
      <div class="footer-col">
        <h4>About</h4>
        <ul>
          <li><a href="contact.html">Contact Us</a></li>
          <li><a href="about.html">About Us</a></li>
          <li><a href="#">Careers</a></li>
          <li><a href="#">GT Stories</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <h4>Help</h4>
        <ul>
          <li><a href="#">Payments</a></li>
          <li><a href="#">Shipping</a></li>
          <li><a href="#">Cancellation</a></li>
          <li><a href="#">FAQ</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <h4>Policy</h4>
        <ul>
          <li><a href="#">Return Policy</a></li>
          <li><a href="#">Terms Of Use</a></li>
          <li><a href="#">Security</a></li>
          <li><a href="#">Privacy</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <h4>Follow Us</h4>
        <div class="social-links">
          <a href="#"><i class="fab fa-facebook-f"></i></a>
          <a href="#"><i class="fab fa-x-twitter"></i></a>
          <a href="https://www.instagram.com/gtmall.in/" target="_blank"><i class="fab fa-instagram"></i></a>
          <a href="#"><i class="fab fa-youtube"></i></a>
        </div>
      </div>
    </div>
    <div class="footer-bottom">
      <p>Â© 2025 GT Mall. All Rights Reserved. | Designed by 
        <a href="https://instagram.com/keshavsuri" target="_blank">Keshav Suri</a>
      </p>
    </div>
  </footer>

  <script>
    const API_BASE = "http://localhost:5000"; // backend URL
    let allOrders = [];

    // ---------- SIMPLE ADMIN PROTECT (for project/demo only) ----------
    function ensureAdminAccess() {
      const isAdmin = localStorage.getItem("isAdmin");
      if (isAdmin === "true") return;

      const code = prompt("Enter admin access code:");
      if (code === "gtadmin123") { // change this if you want
        localStorage.setItem("isAdmin", "true");
        alert("Admin access granted.");
      } else {
        alert("Wrong code. Redirecting to home page.");
        window.location.href = "index.html";
      }
    }

    // ---------- NAVBAR LOGIN/LOGOUT ----------
    function setupNavbarAuth() {
      const userName = localStorage.getItem("userName");
      const loginBtn = document.querySelector(".login-btn");
      const logoutItem = document.getElementById("logout-item");

      if (userName && loginBtn) {
        loginBtn.outerHTML = `<span class="text-success fw-semibold">Hi, ${userName}</span>`;
      }

      if (userName) {
        logoutItem.classList.remove("d-none");
      } else {
        logoutItem.classList.add("d-none");
      }

      const logoutBtn = document.querySelector(".logout-btn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", () => {
          localStorage.removeItem("userName");
          localStorage.removeItem("isAdmin");
          sessionStorage.removeItem("welcomeShown");
          window.location.href = "login_signup.html";
        });
      }
    }

    // ---------- LOAD ORDERS FROM BACKEND ----------
    async function loadOrders() {
      const statusMessage = document.getElementById("statusMessage");
      const totalOrdersSpan = document.getElementById("totalOrders");
      const totalRevenueSpan = document.getElementById("totalRevenue");

      statusMessage.textContent = "Loading orders...";
      statusMessage.style.color = "#555";

      try {
        const res = await fetch(`${API_BASE}/api/orders`);
        const data = await res.json();

        allOrders = Array.isArray(data) ? data : [];

        if (!allOrders.length) {
          statusMessage.textContent = "No orders found yet.";
          statusMessage.style.color = "#555";
        } else {
          statusMessage.textContent = `Loaded ${allOrders.length} order(s) from server.`;
          statusMessage.style.color = "green";
        }

        applyFilters(); // filter + render + stats for current filters
      } catch (err) {
        console.error(err);
        statusMessage.textContent = "Failed to load orders. Is backend running?";
        statusMessage.style.color = "red";
      }
    }

    // ---------- FILTER (SEARCH + DATE) ----------
    function getFilteredOrders() {
      const searchText = document.getElementById("searchInput").value.toLowerCase().trim();
      const dateFromVal = document.getElementById("dateFrom").value;
      const dateToVal = document.getElementById("dateTo").value;

      let fromDate = dateFromVal ? new Date(dateFromVal) : null;
      let toDate = dateToVal ? new Date(dateToVal) : null;

      // If toDate is set, move it to end of that day
      if (toDate) {
        toDate.setHours(23, 59, 59, 999);
      }

      return allOrders.filter(order => {
        const id = (order._id || "").toLowerCase();
        const user = (order.userName || "").toLowerCase();
        const created = order.createdAt ? new Date(order.createdAt) : null;

        // search filter
        const matchSearch = !searchText || id.includes(searchText) || user.includes(searchText);

        // date filter
        let matchDate = true;
        if (fromDate && created) {
          matchDate = matchDate && created >= fromDate;
        }
        if (toDate && created) {
          matchDate = matchDate && created <= toDate;
        }

        return matchSearch && matchDate;
      });
    }

    function applyFilters() {
      const filtered = getFilteredOrders();
      renderOrdersTable(filtered);

      const totalOrdersSpan = document.getElementById("totalOrders");
      const totalRevenueSpan = document.getElementById("totalRevenue");

      totalOrdersSpan.textContent = filtered.length;
      const totalRevenue = filtered.reduce((sum, o) => sum + (o.total || 0), 0);
      totalRevenueSpan.textContent = totalRevenue;
    }

    // ---------- RENDER TABLE ----------
    function renderOrdersTable(orders) {
      const tbody = document.getElementById("ordersTableBody");
      tbody.innerHTML = "";

      if (!orders.length) {
        tbody.innerHTML = `
          <tr><td colspan="7" class="text-center text-muted">No matching orders.</td></tr>
        `;
        return;
      }

      orders.forEach(order => {
        const idShort = order._id ? order._id.slice(-6) : "-----";
        const user = order.userName || "Guest";
        const created = order.createdAt ? new Date(order.createdAt).toLocaleString() : "-";
        const itemCount = Array.isArray(order.items)
          ? order.items.reduce((sum, i) => sum + (i.qty || 0), 0)
          : 0;
        const itemLines = Array.isArray(order.items)
          ? order.items.map(i => `${i.name} (x${i.qty})`).join("<br>")
          : "";

        const status = order.status || "Pending";

        const row = document.createElement("tr");
        row.innerHTML = `
          <td><code>${idShort}</code></td>
          <td>${user}</td>
          <td style="font-size:0.85rem;">${itemCount} item(s)</td>
          <td><strong>${order.total || 0}</strong></td>
          <td>
            <select class="form-select form-select-sm order-status-select" data-id="${order._id}">
              <option value="Pending" ${status === "Pending" ? "selected" : ""}>Pending</option>
              <option value="Shipped" ${status === "Shipped" ? "selected" : ""}>Shipped</option>
              <option value="Delivered" ${status === "Delivered" ? "selected" : ""}>Delivered</option>
              <option value="Cancelled" ${status === "Cancelled" ? "selected" : ""}>Cancelled</option>
            </select>
          </td>
          <td style="font-size:0.8rem;">${created}</td>
          <td style="font-size:0.8rem;">
            ${itemLines || "<span class='text-muted'>No items</span>"}
          </td>
        `;
        tbody.appendChild(row);
      });

      attachStatusListeners();
    }

    // ---------- STATUS UPDATE ----------
    function attachStatusListeners() {
      const selects = document.querySelectorAll(".order-status-select");
      selects.forEach(sel => {
        sel.addEventListener("change", async () => {
          const orderId = sel.dataset.id;
          const newStatus = sel.value;
          const oldValue = sel.getAttribute("data-old") || "";

          sel.disabled = true;

          try {
            const res = await fetch(`${API_BASE}/api/orders/${orderId}/status`, {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ status: newStatus })
            });

            const data = await res.json();
            if (data.success) {
              // update in allOrders
              const updated = data.order;
              const idx = allOrders.findIndex(o => o._id === updated._id);
              if (idx !== -1) {
                allOrders[idx].status = updated.status;
              }
            } else {
              alert("Failed to update status: " + data.error);
              sel.value = oldValue || "Pending";
            }
          } catch (err) {
            console.error(err);
            alert("Error updating status. Check backend.");
            sel.value = oldValue || "Pending";
          } finally {
            sel.disabled = false;
            sel.setAttribute("data-old", sel.value);
          }
        });

        // store initial value
        sel.setAttribute("data-old", sel.value);
      });
    }

    // ---------- EXPORT CSV ----------
    function exportToCSV() {
      const filtered = getFilteredOrders();
      if (!filtered.length) {
        alert("No orders to export (check filters).");
        return;
      }

      let csv = "OrderID,UserName,Total,Status,CreatedAt,Items\n";

      filtered.forEach(order => {
        const id = order._id || "";
        const user = order.userName || "Guest";
        const total = order.total || 0;
        const status = order.status || "Pending";
        const created = order.createdAt ? new Date(order.createdAt).toISOString() : "";
        const items = Array.isArray(order.items)
          ? order.items.map(i => `${i.name} x${i.qty}`).join("; ")
          : "";

        // escape quotes and commas
        function esc(val) {
          const str = String(val).replace(/"/g, '""');
          return `"${str}"`;
        }

        csv += [
          esc(id),
          esc(user),
          esc(total),
          esc(status),
          esc(created),
          esc(items)
        ].join(",") + "\n";
      });

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "gtmall_orders.csv";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    // ---------- INIT ----------
    document.addEventListener("DOMContentLoaded", () => {
      setupNavbarAuth();
      ensureAdminAccess();
      loadOrders();

      document.getElementById("refreshBtn").addEventListener("click", loadOrders);
      document.getElementById("searchInput").addEventListener("input", applyFilters);
      document.getElementById("dateFrom").addEventListener("change", applyFilters);
      document.getElementById("dateTo").addEventListener("change", applyFilters);
      document.getElementById("clearFiltersBtn").addEventListener("click", () => {
        document.getElementById("searchInput").value = "";
        document.getElementById("dateFrom").value = "";
        document.getElementById("dateTo").value = "";
        applyFilters();
      });
      document.getElementById("exportBtn").addEventListener("click", exportToCSV);
    });
  </script>
</body>
</html>
